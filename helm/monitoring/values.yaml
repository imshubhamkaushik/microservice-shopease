# kube-prometheus-stack values
# Aligned with previous manual Prometheus/Grafana setup
# Beginnerâ€“Intermediate, resume-safe


# Prometheus
prometheus:
  enabled: true

  prometheusSpec:
    retention: 10d

    # Allow Prometheus to discover ServiceMonitors created by the chart
    serviceMonitorSelectorNilUsesHelmValues: false

    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# Alertmanager
alertmanager:
  enabled: true

  alertmanagerSpec:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 256Mi

  config:
    route:
      receiver: "default"
    receivers:
      - name: "default"

# Grafana
grafana:
  enabled: true

  #This is explicitly for demo. Never do this in real prod
  adminUser: admin
  adminPassword: admin

  service:
    type: NodePort

  resources:
    requests:
      cpu: 250m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# Custom Alert Rules (Equivalent to prometheus-alerts.yaml)
additionalPrometheusRules:
  - name: application-alerts
    groups:
      - name: service-availability
        rules:
          - alert: ServiceDown
            expr: max by (service, namespace) (up) == 0 # absent(up{job="kubernetes-service-endpoints"}) if up == 0 doesnt work
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Service {{ $labels.service }} is DOWN"
              description: "Service {{ $labels.service }} is not responding."

      - name: cpu-alerts
        rules:
          - alert: HighCPUUsage
            expr: process_cpu_usage > 0.80
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ $labels.service }} detected"
              description: "CPU usage above 80%."

      - name: jvm-memory-alerts
        rules:
          - alert: HighJVMMemoryUsage
            expr: |
              (
                jvm_memory_used_bytes{area="heap"}
                /
                jvm_memory_max_bytes{area="heap"}
              ) > 0.80
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "High JVM heap usage on {{ $labels.service }}"
              description: "Heap usage exceeded 80%."
